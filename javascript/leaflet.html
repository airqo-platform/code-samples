<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Quality Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <style>
        #map {
            height: 400px;
        }
 
    </style>
</head>
<body>
    <div id="map"></div>
   

    <script>
         var map = L.map('map', {attributionControl: false}).setView([0.3136, 32.5810], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Create a custom attribution control
        L.control.attribution({
            prefix: '<a href="https://airqo.net/" target="_blank">Powered by AirQo</a>', // Set your custom attribution text
            position: 'bottomright' // Position the control
        }).addTo(map);
       
       
        var apiEndpoint = 'https://api.airqo.net/api/v2/devices/measurements/grids/{GRID_ID}';
        var accessToken = "your-access-token";
        var gridId = 'your-grid-id'

        $.ajax({
            url: apiEndpoint.replace('{GRID_ID}', gridId).concat('?token=' + accessToken),
            method: 'GET',
            success: function(apiResponse) {
                apiResponse.measurements.forEach(function(measurement) {
                    var lat = measurement.siteDetails.approximate_latitude;
                    var lon = measurement.siteDetails.approximate_longitude;
                    var pm25Value = Math.round(measurement.pm2_5.value);
                    var siteName = measurement.siteDetails.description;
                    var aqi = measurement.pm2_5.value;

                    createMarker(lat, lon, aqi, pm25Value, siteName);
                });
                addLegend();
            },
            error: function(error) {
                console.error('Error fetching data:', error);
            }
        });

        function getAqiColor(aqi) {
            if (aqi >= 0 && aqi <= 12) return 'green';
            if (aqi > 12 && aqi <= 35.4) return 'yellow';
            if (aqi > 35.4 && aqi <= 55.4) return 'orange';
            if (aqi > 55.4 && aqi <= 150.4) return 'red';
            if (aqi > 150.4 && aqi <= 250.4) return 'purple';
            if (aqi > 250.4 && aqi <= 500) return 'maroon';
            return 'unknown'; // Fallback for values outside the expected range
        }

        function createMarker(lat, lon, aqi, pm25Value, siteName) {
            var aqiColor = getAqiColor(aqi);
            var marker = L.marker([lat, lon], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10],
                    popupAnchor: [0, -30],
                    html: '<div style="background-color: ' + aqiColor + '; width: 30px; height: 30px; border-radius: 50%; text-align: center; line-height: 30px; color: black;">' + pm25Value + '</div>'
                })
            }).addTo(map)
            .bindPopup('<b>' + siteName + '</b><br>PM2.5 Value: ' + pm25Value + '<br>AQI: ' + aqi);
        }

        function addLegend() {
            var legend = L.control({position: 'bottomleft'});

            legend.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'info legend'),
                aqiIndex = {
                    good: [0, 12],
                    moderate: [12.1, 35.4],
                    u4sg: [35.5, 55.4],
                    unhealthy: [55.5, 150.4],
                    very_unhealthy: [150.5, 250.4],
                    hazardous: [250.5, 500]
                },
                labels = [];

                for (var category in aqiIndex) {
                    var color = getAqiColor(aqiIndex[category][0]);
                    div.innerHTML +=
                        '<i style="background:' + color + '"></i> ' +
                        aqiIndex[category][0] + ' - ' + aqiIndex[category][1] + ': ' + category + '<br>';
                }

                return div;
            };

            legend.addTo(map);
        }
    </script>
</body>
</html>
